
<%-
#
# CBRAIN Project
#
# Copyright (C) 2008-2012
# The Royal Institution for the Advancement of Learning
# McGill University
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.
#
-%>

<%
# Partial variables needed here:
#   tool      => a tool object
#   bourreaux => list of bourreaux
#   users     => list of users
%>

<fieldset>

  <legend>
      Tool: <%= link_to tool.name, edit_tool_path(tool) %>
      in project '<%= link_to_group_if_editable(tool.group) %>'
  </legend>

  <% cycle("list-odd", "list-even") if cycle("list-odd", "list-even") == 'list-odd' %>

  <%
     user_can_access_tool = {}
     users.each do |user|
       user_can_access_tool[user] = tool.can_be_accessed_by?(user)
     end
  %>

  <table>

    <tr>
      <th>Execution Servers</th>
      <th>Versions Configured</th>
      <th>Projects In Effect</th>
      <th>Users</th>
    </tr>

    <% bourreaux.each do |bourreau| %>

      <%
         user_can_access_bourreau = {}
         users.each do |user|
           user_can_access_bourreau[user] = bourreau.can_be_accessed_by?(user)
         end
      %>

      <% tcs = ToolConfig.where( :tool_id => tool.id, :bourreau_id => bourreau.id ) %>
      <% if tcs.size == 0 %>
        <tr class="<%= cycle("list-odd", "list-even") %>">
          <td class="left_align no_wrap">
            <%= link_to_bourreau_if_accessible(bourreau, nil, :path => bourreau_path(bourreau)) %>
            in project '<%= link_to_group_if_editable(bourreau.group) %>'
          </td>
          <td class="left_align no_wrap"><%= html_colorize("No versions configured") %></td>
          <td class="left_align"><%= html_colorize("-") %></td>
          <td class="left_align"><%= html_colorize("-") %></td>
        </tr>
      <% end %>
      <% tcs.each_with_index do |tc,idx| %>
        <tr class="<%= cycle("list-odd", "list-even") %>">
        <% if idx == 0 %>
          <td rowspan="<%= tcs.size %>" class="left_align no_wrap">
            <%= link_to_bourreau_if_accessible(bourreau, nil, :path => bourreau_path(bourreau)) %>
            in project '<%= link_to_group_if_editable(bourreau.group) %>'
          </td>
        <% end %>
          <td class="left_align no_wrap">
            <%= link_to tc.version_name, edit_tool_config_path(tc) %>
            in project '<%= link_to_group_if_editable(tc.group) %>'
          </td>
          <td class="left_align no_wrap">
            <%
               projs = [ bourreau.group, tool.group, tc.group ]
               projs.reject! { |g| g.name == 'everyone' }
               projs = projs.uniq
            %>
            <% if projs.size == 0 %>
              <%= html_colorize("'everyone'", 'green') %>
            <% else %>
              <% links = projs.map { |g| link_to_group_if_editable(g) } %>
              <%= links.join(" &cap; ").html_safe %>
            <% end %>
          </td>
          <td class="left_align">
            <%= array_to_table(users, :rows => 1, :table_class => 'simple') do |user,r,c| %>
              <%
                user_can_access_tc = tc.can_be_accessed_by?(user)
                access_ok          = user_can_access_bourreau[user] && user_can_access_tool[user] && user_can_access_tc
              %>
              <% if access_ok %>
                <%= user.login %>
              <% else %>
                <%= html_tool_tip(html_colorize(user.login)) do %>
                  <%= "* Execution Server's project<br/>".html_safe      unless user_can_access_bourreau[user] %>
                  <%= "* Tool's project<br/>".html_safe                  unless user_can_access_tool[user] %>
                  <%= "* Version configuration's project<br/>".html_safe unless user_can_access_tc %>
                <% end %>
              <% end %>
            <% end %>
          </td>
        </tr>
      <% end %>
    <% end %>
  </table>

</fieldset>

