
<% title 'Execution Server Info' %>

<h2>Information for <%= @bourreau.name %></h2>

<% is_bourreau = @bourreau.is_a?(Bourreau) %>

<div class="generalbox">
    
  <% if check_role(:admin) || @bourreau.user_id == current_user.id %>
    <div class="menu_bar">
      <%= link_to 'Edit', edit_bourreau_path(@bourreau), { :class => "button" } %>
      <%= link_to 'Delete', bourreau_path(@bourreau), { :confirm => "Are you sure you want to delete '#{@bourreau.name}' ?", :method => :delete, :class => "button" } %>
    </div>
  <% end %>

  <P>

  <table class = "property_list">

    <tr>
      <th colspan="2" class="subtitle">Implementation information</th>
    </tr>

    <tr class="<%= cycle("list-odd", "list-even") %>">
      <th>Description</th>
      <td class="left_align"><%= overlay_description(@bourreau.description) %></td>
    </tr>
    
    <tr class="<%= cycle("list-odd", "list-even") %>">
      <th>Revision Info (Client Side)</th>
      <td class="left_align"><%= Bourreau.revision_info.svn_id_pretty_rev_author_date %></td>
    </tr>
    
    <tr class="<%= cycle("list-odd", "list-even") %>">
      <th>Class</th>
      <td class="left_align"><%= @bourreau.class.to_s %></td>
    </tr>

    <tr>
      <th colspan="2" class="subtitle">Access information</th>
    </tr>

    <tr class="<%= cycle("list-odd", "list-even") %>">
      <th>Owner</th>
      <td class="left_align"><%= link_to_user_with_tooltip(@bourreau.user) %></td>
    </tr>

    <tr class="<%= cycle("list-odd", "list-even") %>">
      <th>Project</th>
      <td class="left_align"><%= link_to_group_if_accessible(@bourreau.group) %></td>
    </tr>

    <tr class="<%= cycle("list-odd", "list-even") %>">
      <th>Status</th>
      <td class="left_align"><%= @bourreau.online ? "Online" : "Offline" %></td>
    </tr>
    
    <tr class="<%= cycle("list-odd", "list-even") %>">
      <th>Time Zone</th>
      <td class="left_align"><%= @bourreau.time_zone || "(Unset)" %></td>
    </tr>
    
    <tr class="<%= cycle("list-odd", "list-even") %>">
      <th>Site</th>
      <td class="left_align"><%= link_to_site_if_accessible(@bourreau.site_affiliation) %></td>
    </tr>

    <% if (check_role(:admin) || @bourreau.user_id == current_user.id)%>
    
      <tr>
        <th colspan="2" class="subtitle">ActiveResource Configuration (Obsolete!)</th>
      </tr>

      <tr class="<%= cycle("list-odd", "list-even") %>">
        <th>Host</th>
        <td class="left_align"><%= @bourreau.actres_host %></td>
      </tr>

      <tr class="<%= cycle("list-odd", "list-even") %>">
        <th>Port</th>
        <td class="left_align"><%= @bourreau.actres_port %></td>
      </tr>

      <tr>
        <th colspan="2" class="subtitle">SSH Remote Control Configuration</th>
      </tr>

      <tr class="<%= cycle("list-odd", "list-even") %>">
        <th>Hostname</th>
        <td class="left_align"><%= @bourreau.ssh_control_host %></td>
      </tr>

      <tr class="<%= cycle("list-odd", "list-even") %>">
        <th>User</th>
        <td class="left_align"><%= @bourreau.ssh_control_user %></td>
      </tr>

      <tr class="<%= cycle("list-odd", "list-even") %>">
        <th>Port</th>
        <td class="left_align"><%= @bourreau.ssh_control_port %></td>
      </tr>

      <tr class="<%= cycle("list-odd", "list-even") %>">
        <th>Rails Server Directory</th>
        <td class="left_align"><%= @bourreau.ssh_control_rails_dir %></td>
      </tr>

      <tr class="<%= cycle("list-odd", "list-even") %>">
        <th>Second-level Hostname</th>
        <td class="left_align"><%= @bourreau.proxied_host %></td>
      </tr>

      <tr>
        <th colspan="2" class="subtitle">Tunnelling Configuration</th>
      </tr>

      <% if is_bourreau %>
        <tr class="<%= cycle("list-odd", "list-even") %>">
          <th>Database Server Remote Tunnel Port</th>
          <td class="left_align"><%= @bourreau.tunnel_mysql_port %></td>
        </tr>
      <% end %>

      <tr class="<%= cycle("list-odd", "list-even") %>">
        <th>ActiveResource Remote Tunnel Port</th>
        <td class="left_align"><%= @bourreau.tunnel_actres_port %></td>
      </tr>
      
      <tr>
        <th colspan="2" class="subtitle">Cache Management Configuration</th>
      </tr>

      <tr class="<%= cycle("list-odd", "list-even") %>">
        <th>Path to Data Provider caches</th>
        <td class="left_align"><%= @bourreau.dp_cache_dir %></td>
      </tr>

      <tr class="<%= cycle("list-odd", "list-even") %>">
        <th>Patterns for filenames to ignore</th>
        <td class="left_align"><%= @bourreau.dp_ignore_patterns %></td>
      </tr>
      
      <tr class="<%= cycle("list-odd", "list-even") %>">
        <th>Cache Expiration Timeout (in seconds)</th>
        <td class="left_align"><%= @bourreau.cache_trust_expire == 0 ? "Never" : @bourreau.cache_trust_expire %></td>
      </tr>

      <% if is_bourreau %>
    
        <tr>
            <th colspan="2" class="subtitle">Tool Version Configuration</th>
        </tr>
        
        <tr class="<%= cycle("list-odd", "list-even") %>">
          <th>Common configuration for all tasks</th>
          <% tool_config = ToolConfig.where(:bourreau_id => @bourreau.id, :tool_id => nil).first %>
          <td class="left_align"><%= tool_config ? (link_to "Show", tool_config_path( :id => tool_config)) : "No tool config" %></td>
        </tr>
      
        <tr>
            <th colspan="2" class="subtitle">Cluster Management System Configuration</th>
        </tr>
      
        <tr class="<%= cycle("list-odd", "list-even") %>">
          <th>Type of cluster</th>
          <td class="left_align"><%= @bourreau.cms_class %></td>
        </tr>
      
        <tr class="<%= cycle("list-odd", "list-even") %>">
          <th>Path to shared work directory</th>
          <td class="left_align"><%= @bourreau.cms_shared_dir %></td>
        </tr>
      
        <tr class="<%= cycle("list-odd", "list-even") %>">
          <th>Default queue name</th>
          <td class="left_align"><%= @bourreau.cms_default_queue %></td>
        </tr>
    
        <tr class="<%= cycle("list-odd", "list-even") %>">
          <th>Extra 'qsub' options</th>
          <td class="left_align"><%= @bourreau.cms_extra_qsub_args %></td>
        </tr>
       
        <tr>
            <th colspan="2" class="subtitle">Bourreau Workers Configuration</th>
        </tr>
      
        <tr class="<%= cycle("list-odd", "list-even") %>">
          <th>Number of Workers</th>
          <td class="left_align"><%= @bourreau.workers_instances %></td>
        </tr>
      
        <tr class="<%= cycle("list-odd", "list-even") %>">
          <th>Check interval</th>
          <td class="left_align"><%= @bourreau.workers_chk_time %></td>
        </tr>
      
        <tr class="<%= cycle("list-odd", "list-even") %>">
          <th>Log destination</th>
          <td class="left_align"><%= @bourreau.workers_log_to %></td>
        </tr>
      
        <tr class="<%= cycle("list-odd", "list-even") %>">
          <th>Log verbosity</th>
          <td class="left_align"><%= ['(Not configured)', 'Normal', 'Debug info' ][@bourreau.workers_verbose || 0] %></td>
        </tr>
      
        <tr>
            <th colspan="2" class="subtitle">Task Limits</th>
        </tr>
      
        <tr class="<%= cycle("list-odd", "list-even") %>">
          <th>Maximum total number of active tasks</th>
          <td class="left_align"><%= @bourreau.meta["task_limit_total"].blank? ? "Unlimited" : @bourreau.meta["task_limit_total"]%></td>
        </tr>
      
        <tr class="<%= cycle("list-odd", "list-even") %>">
          <th>Default maximum number of active tasks for each user</th>
          <td class="left_align"><%= @bourreau.meta["task_limit_user_default"].blank? ? "Server's max" : @bourreau.meta["task_limit_user_default"] %></td>
        </tr>
      
        <tr class="<%= cycle("list-odd", "list-even") %>">
          <th>Maximum number of active tasks per user</th>
          <td>  
          <%= array_to_table(@users.sort { |a,b| a.login <=> b.login }, :table_class => 'simple', :td_class => 'right', :cols => 4) do |user,r,c| %>
            <% metkey = "task_limit_user_#{user.id}".to_sym %>
            <%= link_to_user_with_tooltip(user) %>:
            </td><td class="no_left_right_padding">
                <%= @bourreau.meta[metkey].blank? ? "Default" : @bourreau.meta[metkey] %>
          <% end %>
          </td>
        </tr>
        
      <% end %>
    <% end %>

    <tr>
      <th colspan="2" class="subtitle">Runtime Information</th>
    </tr>

    <% if @info.name == "???" %>

      <tr>
        <td colspan="2">This server is currently <font color="red">DOWN</font>.</td>
      </tr>

    <% else %>

      <tr class="<%= cycle("list-odd", "list-even") %>">
        <th>Revision Info (Server Side)</th>
        <td class="left_align">
          <strong>Process Start Revision: </strong><%= @info.starttime_revision %><br/>
          <strong>Process Start Last Change Author: </strong><%= @info.lc_author %><br/>
          <strong>Process Start Last Change Revision: </strong><%= @info.lc_rev %><br/>
          <strong>Process Start Last Change Date: </strong><%= @info.lc_date %><br/>
          <strong>Disk Code Revision: </strong><%= red_if(@info.revision != @info.starttime_revision, @info.revision) %>
        </td>
      </tr>

      <tr class="<%= cycle("list-odd", "list-even") %>">
        <th>Host name</th>
        <td class="left_align"> <%= @info.host_name == @bourreau.ssh_control_host ? @info.host_name : html_colorize(@info.host_name, "red") %>
        </td>
      </tr>

      <tr class="<%= cycle("list-odd", "list-even") %>">
        <th>Host IP address</th>
        <td class="left_align"><%= @info.host_ip %></td>
      </tr>

      <tr class="<%= cycle("list-odd", "list-even") %>">
        <th>Host OS type</th>
        <td class="left_align"><%= @info.host_uname %></td>
      </tr>

      <tr class="<%= cycle("list-odd", "list-even") %>">
        <th>Host uptime</th>
        <td class="left_align"><%= @info.host_uptime %></td>
      </tr>

      <tr class="<%= cycle("list-odd", "list-even") %>">
        <th>Server uptime</th>
        <td class="left_align">
          Up since: <%= to_localtime(@info.uptime.to_i.ago,:datetime) %><br>
          (for: <%= pretty_elapsed(@info.uptime.to_i) %>)
        </td>
      </tr>

      <% if is_bourreau %>
        <tr class="<%= cycle("list-odd", "list-even") %>">
          <th>Worker PIDs</th>
          <td class="left_align"><%= @info.worker_pids %></td>
        </tr>

        <tr class="<%= cycle("list-odd", "list-even") %>">
          <th>Worker Revision Info</th>
          <td class="left_align">
            <strong>Last Change Author: </strong><%= @info.worker_lc_author %><br>
            <strong>Last Change Revision: </strong><%= @info.worker_lc_rev %><br>
            <strong>Last Change Date: </strong><%= @info.worker_lc_date %>
          </td>
        </tr>

        <tr class="<%= cycle("list-odd", "list-even") %>">
          <th>Number of tasks (running/max)</th>
          <td class="left_align"><%= @info.tasks_tot + " / " + @info.tasks_max %></td>
        </tr>

        <tr class="<%= cycle("list-odd", "list-even") %>">
          <th>Cluster Management System</th>
          <td class="left_align">
            Type: <%= @bourreau.cms_class == @info.bourreau_cms ? @info.bourreau_cms : html_colorize(@info.bourreau_cms, "red") %><br>
            Rev:  <%= @info.bourreau_cms_rev.svn_id_pretty_rev_author_date %>
          </td>
        </tr>
      <% end %>

      <tr class="<%= cycle("list-odd", "list-even") %>">
        <th>SSH Public Key</th>
        <td class="left_align"><SMALL><SMALL><PRE class="ssh_key"><%= @info.ssh_public_key.strip %><PRE></SMALL></SMALL></td>
      </tr>

    <% end %>

  </table>

  <% if is_bourreau %>

  <P>

  <%= render :partial => 'tasks/task_counts',
             :locals => { :counts           => @statuses,
                          :list             => @statuses_list,
                          :user_info        => @user_tasks_info,
                          :additionnal_filt => {:bourreau_id => @bourreau.id},
                          :by               => :status
                        }
  %>
  
  <P>
  
  <%= render :partial => 'tasks/task_counts',
             :locals => { :counts           => @types,
                          :list             => @types_list,
                          :user_info        => @user_types_info,
                          :additionnal_filt => {:bourreau_id => @bourreau.id},
                          :by               => :type
                        }
  %>
  
  
  <P>

  <% end %>

  <P>

  <%= render :partial => "layouts/log_report", :locals  => { :log  => @log, :title => "Server Log" } %>

</div>  <!-- End class="generalbox" -->

