
<%-
#
# CBRAIN Project
#
# Copyright (C) 2008-2012
# The Royal Institution for the Advancement of Learning
# McGill University
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.  
#
-%>

<% 
  is_bourreau = @bourreau.is_a?(Bourreau)
  is_portal   = @bourreau.is_a?(BrainPortal) 
  info = @bourreau.info
 %>

<% title is_portal ? 'Portal Info' : 'Execution Server Info' %>
   
<% if check_role(:admin_user) || @bourreau.user_id == current_user.id %>
  <div class="menu_bar">
    <% if is_bourreau %>    

      <%= link_to 'Task Statistics By Status', report_path(:table_name => :cbrain_tasks, :bourreau_id => @bourreau.id, :row_type => :user_id , :col_type => :status, :generate => "ok" ), :class => "button" %>

      <%= link_to 'Task Statistics By Type', report_path(:table_name => :cbrain_tasks, :bourreau_id => @bourreau.id, :row_type => :user_id , :col_type => :type, :generate => "ok" ), :class => "button" %>
    
    <%end%>
    
    <%= link_to 'Delete', bourreau_path(@bourreau), { :confirm => "Are you sure you want to delete '#{@bourreau.name}' ?", :method => :delete, :class => "button" } %>
  </div>
<% end %>

<P>

<%= error_messages_for @bourreau, :header_message => "Server could not be updated." %>

<div class="display_inline_block" style="min-width: 50%">



  <%= show_table(@bourreau, :edit_condition => @bourreau.has_owner_access?(current_user)) do |t| %>

    <% t.edit_cell(:name) do %>
      <%= text_field_tag "bourreau[name]", @bourreau.name %><br>
      <div class="field_explanation">
        Important note: this name must also be changed accordingly in the config file
        <em><%= is_bourreau ? "Bourreau/config/initializers/config_bourreau.rb" : "BrainPortal/config/initializers/config_portal.rb" %></em>
        for this server to restart properly later on.
      </div>
    <% end %>

    <% t.edit_cell(:description, :content =>  overlay_description(@bourreau.description)) do %>
      <%= text_area_tag "bourreau[description]", @bourreau.description, :rows => 10, :cols => 40 %><br>
      <div class="field_explanation">The first line should be a short summary, and the rest are for any special notes for the users.</div><br>
    <% end %>

    <% t.attribute_cell(:class) %>

    <% t.edit_cell(:online, :header => "Status", :content => (@bourreau.online ? "Online" : "Offline")) do %>
      <%= select_tag "bourreau[online]", options_for_select([["Online", true], ["Offline", false]], :selected => @bourreau.online) %>
    <% end %>

    <% t.edit_cell(:user_id, :header => "Owner", :content => link_to_user_with_tooltip(@bourreau.user), :disabled => ! current_user.has_role?(:admin_user)) do %>
      <%= user_select("bourreau[user_id]", { :selector => @bourreau } ) %>
    <% end %>

    <% t.edit_cell(:time_zone, :content => (@bourreau.time_zone || "(Unset)") ) do %>
      <%= select_tag "bourreau[time_zone]", time_zone_options_for_select(@bourreau.time_zone, /canada/i), :include_blank => true %>
    <% end %>

    <% t.edit_cell(:group_id, :header => "Project", :content => link_to_group_if_accessible(@bourreau.group)) do %>
      <%= group_select("bourreau[group_id]", {:selector => @bourreau} ) %>
    <% end %>

    <% t.cell("Revision Info (Client Side)") { Bourreau.revision_info.svn_id_pretty_rev_author_date } %>

    <% t.cell("Site") { link_to_site_if_accessible(@bourreau.site_affiliation) } %>

    <% if is_portal %>

      <% t.edit_cell(:license_agreements, :content => @bourreau.license_agreements.join(", ")) do %>
        <%= text_area_tag "bourreau[license_agreements]", @bourreau.license_agreements.join("\n"), :rows => 5, :cols => 40 %><br>
        <div class="field_explanation">Enter one agreement name per line. Note that only alphanumeric characters, underscores (_) and dashes (-) are accepted.</div>
      <% end %>
      
      <% t.edit_cell(:support_email, :header => "Support email address") do %>
        <%= text_field_tag "bourreau[support_email]", @bourreau.support_email, :size => 30 %><br/>
        <div class="field_explanation">If set, the portal will show a <em>mailto:</em> link for letting users contact support.</div>
      <% end %>

      <% t.edit_cell(:help_url, :header => "User Manual URL") do %>
        <%= text_field_tag "bourreau[help_url]", @bourreau.help_url, :size => 40 %><br/>
        <div class="field_explanation">If set, the portal will show a link called 'User Manual' in the account bar at the top.</div>
      <% end %>

    <% end %>

    <% t.edit_cell(:system_from_email, :header => "System 'From' reply address") do %>
      <%= text_field_tag "bourreau[system_from_email]", @bourreau.system_from_email, :size => 30 %><br/>
      <div class="field_explanation">If set, messages sent automatically by this system will contain this return address.</div>
    <% end %>

  <% end %>



  <% if (check_role(:admin_user) || @bourreau.user_id == current_user.id) %>

    <% if is_bourreau %>

      <%= show_table(@bourreau, :header => "Connection Configuration", :edit_condition => @bourreau.has_owner_access?(current_user)) do |t| %>

        <% t.edit_cell(:ssh_control_host, :header => "SSH Hostname") do %>
          <%= text_field_tag "bourreau[ssh_control_host]", @bourreau.ssh_control_host %>
        <% end %>

        <% t.edit_cell(:ssh_control_rails_dir, :header => "Rails Server Directory") do %>
          <%= text_field_tag "bourreau[ssh_control_rails_dir]", @bourreau.ssh_control_rails_dir, :size => 60 %>
        <% end %>

        <% t.edit_cell(:ssh_control_user, :header => "SSH User") do %>
          <%= text_field_tag "bourreau[ssh_control_user]", @bourreau.ssh_control_user %>
        <% end %>

        <% t.edit_cell(:tunnel_mysql_port, :header => "Database Server Remote Tunnel Port") do %>
          <%= text_field_tag "bourreau[tunnel_mysql_port]", @bourreau.tunnel_mysql_port, :size => 6 %>
        <% end %>

        <% t.edit_cell(:ssh_control_port, :header => "SSH Port") do %>
          <%= text_field_tag "bourreau[ssh_control_port]", @bourreau.ssh_control_port, :size => 6 %>
        <% end %>

        <% t.edit_cell(:tunnel_actres_port, :header => "ActiveResource Remote Tunnel Port") do %>
          <%= text_field_tag "bourreau[tunnel_actres_port]", @bourreau.tunnel_actres_port, :size => 6 %>
        <% end %>

        <% t.edit_cell(:proxied_host, :header => "Second-level Hostname") do %>
          <%= text_field_tag "bourreau[proxied_host]", @bourreau.proxied_host %>
        <% end %>

      <% end %>

    <% end %>



    <%= show_table(@bourreau, :header => "Cache Management Configuration", :edit_condition => @bourreau.has_owner_access?(current_user)) do |t| %>
      <% t.edit_cell(:dp_cache_dir, :header => "Path to Data Provider caches") do %>
        <%= text_field_tag "bourreau[dp_cache_dir]", @bourreau.dp_cache_dir, :size => 60 %><br/>
        <div class="field_explanation">Warning! Changing this field will result in resetting the synchronization
        status of all files from all Data Providers! Also, the Rails app will have to
        be restarted, and all files in that directory will be erased!</div>
      <% end %>
      <% t.edit_cell(:spaced_dp_ignore_patterns, :header => "Patterns for filenames to ignore", :content => @bourreau.spaced_dp_ignore_patterns) do %>
        <%= text_field_tag "bourreau[spaced_dp_ignore_patterns]", @bourreau.spaced_dp_ignore_patterns, :size => 60 %><br/>
        <div class="field_explanation">Separate several patterns with spaces; each pattern can contain<br> single '*'s, but no '/'s or special characters.</div>
      <% end %>
      <% t.edit_cell(:cache_trust_expire, :header => "Cache Expiration Timeout (in seconds)", :content => (@bourreau.cache_trust_expire == 0 ? "Never" : @bourreau.cache_trust_expire)) do %>
        <%= select_tag("bourreau[cache_trust_expire]", options_for_select([
                [ "Never",        "0"                  ],
                [ "Six hours",     6.hours.to_i.to_s   ],
                [ "Twelve hours", 12.hours.to_i.to_s   ],
                [ "One day",       1.day.to_i.to_s     ],
                [ "Three days",    3.days.to_i.to_s    ],
                [ "One week",      1.week.to_i.to_s    ],
                [ "Two weeks",     2.weeks.to_i.to_s   ],
                [ "One month",     1.month.to_i.to_s   ],
                [ "Two months",    2.months.to_i.to_s  ],
                [ "Three months",  3.months.to_i.to_s  ],
                [ "Six months",    6.months.to_i.to_s  ]
            ], :selected => @bourreau.cache_trust_expire ))
        %></br>
        <div class="field_explanation">This means that in the execution server's cache, files that have been recorded
        as 'InSync' but were last accessed more than this amount of time will be considered untrustworthy
        and will be re-synchronized the next time they are accessed. Set this to a value less than <em>N</em>
        if the cluster's file policy, for instance, deletes all scratch files older than <em>N</em> days.</div>
      <% end %>
    <% end %>



    <% if is_bourreau %>
      <%= show_table(@bourreau, :header => "Cluster Configuration", :edit_condition => @bourreau.has_owner_access?(current_user)) do |t| %>

        <% t.edit_cell(:cms_class, :header => "Type of cluster") do %>
          <%= select_tag "bourreau[cms_class]", options_for_select([
                  [ "(Unconfigured)",  "" ],
                  [ "Sun GridEngine",  "ScirSge" ],
                  [ "PBS",             "ScirPbs" ],
                  [ "MOAB",            "ScirMoab" ],
                  [ "Sharcnet custom", "ScirSharcnet" ],
                  [ "UNIX processes",  "ScirUnix" ]
              ], :selected => @bourreau.cms_class)
          %>
        <% end %>

        <% t.edit_cell(:cms_default_queue, :header => "Default queue name") do %>
          <%= text_field_tag "bourreau[cms_default_queue]", @bourreau.cms_default_queue %><br/>
          <div class="field_explanation">Optional.</div>
        <% end %>

        <% t.edit_cell 'meta[task_limit_total]', :header => "Maximum total number of active tasks", :content => (@bourreau.meta["task_limit_total"].blank? ? "Unlimited" : @bourreau.meta["task_limit_total"]) do %>
          <%= select_tag 'meta[task_limit_total]',
              options_for_select( [ [ "Unlimited", "" ] ] + %w( 1 2 3 4 5 8 10 15 20 25 30 35 40 45 50 60 75 100 200 500 1000 ) ,
                                  @bourreau.meta[:task_limit_total] )
          %>
        <% end %>

        <% t.edit_cell(:cms_extra_qsub_args, :header => "Extra 'qsub' options") do %>
          <%= text_field_tag "bourreau[cms_extra_qsub_args]", @bourreau.cms_extra_qsub_args, :size => 60 %><br/>
          <div class="field_explanation">Optional. Careful, this is inserted as-is in the command-line for submitting jobs.</div>
        <% end %>

        <% t.edit_cell 'meta[task_limit_user_default]', 
                       :header => "Default maximum number of active tasks for each user", 
                       :content => (@bourreau.meta["task_limit_user_default"].blank? ? "Server's max" : @bourreau.meta["task_limit_user_default"]) do %>
          <%= select_tag 'meta[task_limit_user_default]',
              options_for_select( [ [ "Server's max", "" ] ] + %w( 1 2 3 4 5 8 10 15 20 25 30 35 40 45 50 60 75 100 200 500 1000 ) ,
                                  @bourreau.meta[:task_limit_user_default] )
          %>
          <div class="field_explanation">(Unless specified below)</div>
        <% end %>

        <% t.cell("Common configuration for all tasks") do %>
          <% tool_config = ToolConfig.where(:bourreau_id => @bourreau.id, :tool_id => nil).first %>
          <%= tool_config ? (link_to "Show", tool_config_path( :id => tool_config)) : "No tool config" %>
        <% end %>

        <% t.edit_cell(:cms_shared_dir, :header => "Path to shared work directory", :show_width => 2) do %>
          <%= text_field_tag "bourreau[cms_shared_dir]", @bourreau.cms_shared_dir, :size => 60 %><br/>
          <div class="field_explanation">Mandatory. This directory must be visible and writable from all nodes.
                 This is were the work subdirectories for all tasks will be created.</div>
        <% end %>

        <% content = capture do %>
          <%= array_to_table(@users.sort { |a,b| a.login <=> b.login }, :table_class => 'simple', :td_class => 'right', :cols => 4, :fill_by_columns => true) do |user,r,c| %>
            <% metkey = "task_limit_user_#{user.id}".to_sym %>
            <%= link_to_user_with_tooltip(user) %>:
            </td><td class="some_left_right_padding">
            <%= @bourreau.meta[metkey].blank? ? "Default" : @bourreau.meta[metkey] %>
          <% end %>
        <% end %>

        <% t.edit_cell 'meta[task_limit_user_default]', 
                       :header => "Maximum number of active tasks per user", 
                       :content => content, :show_width => 2 do %>
          <%= array_to_table(@users.sort { |a,b| a.login <=> b.login }, :table_class => 'simple', :td_class => 'right', :cols => 4, :fill_by_columns => true) do |user,r,c| %>
            <% metkey = "task_limit_user_#{user.id}".to_sym %>
            <%= link_to_user_with_tooltip(user) %>:
            </td><td class="some_left_right_padding">
            <%= select_tag "meta[#{metkey}]",
                options_for_select( [ [ "Default", "" ] ] + %w( 1 2 3 4 5 8 10 15 20 25 30 35 40 45 50 60 75 100 150 200 250 300 400 500 750 1000 ) ,
                                    @bourreau.meta[metkey] )
            %>
          <% end %>
        <% end %>
      <% end %>
      <%= show_table(@bourreau, :header => "Worker Configuration", :edit_condition => @bourreau.has_owner_access?(current_user)) do |t| %>
        <% t.edit_cell :workers_instances, :header => "Number of workers" do %>
          <%= select_tag "bourreau[workers_instances]", options_for_select([
                  [ "None (for debug)",  0 ],
                  [ "1",                 1 ],
                  [ "2",                 2 ],
                  [ "3",                 3 ],
                  [ "4",                 4 ],
                  [ "5",                 5 ],
                  [ "10",                10 ],
                  [ "20",                20 ]
              ], :selected => @bourreau.workers_instances)
          %>
        <% end %>
        <% t.edit_cell :workers_chk_time, :header => "Check interval" do %>
          <%= select_tag "bourreau[workers_chk_time]", options_for_select([
                  [ "5 seconds",               5 ],
                  [ "10 seconds",              10 ],
                  [ "30 seconds",              30 ],
                  [ "1 minute (recommended)",  60 ],
                  [ "2 minutes",               120 ],
                  [ "5 minutes",               300 ],
                  [ "15 minutes",              900 ],
                  [ "1 hour",                  3600 ]
              ], :selected => @bourreau.workers_chk_time)
          %>
        <% end %>
        <% t.edit_cell :workers_log_to, :header => "Log destination" do %>
          <%= select_tag "bourreau[workers_log_to]", options_for_select([
                  [ "Combined file (recommended)", "combined" ],
                  [ "Separate files",              "separate" ],
                  [ "RAILS log",                   "bourreau" ],
                  [ "RAILS stdout",                "stdout" ],
                  [ "RAILS stderr",                "stderr" ],
                  [ "RAILS stdout and stderr",     "stdout|stderr" ],
                  [ "No logging",                  "none" ]
              ], :selected => @bourreau.workers_log_to)
          %>
        <% end %>
        <% t.edit_cell :workers_verbose, :header => "Log verbosity", :content => ['(Not configured)', 'Normal', 'Debug info' ][@bourreau.workers_verbose || 0]  do %>
          <%= select_tag "bourreau[workers_verbose]", options_for_select([
                  [ "Normal",      1 ],
                  [ "Debug info",  2 ]
              ], :selected => @bourreau.workers_verbose)
          %>
        <% end %>
      <% end %>
    <% end %>



    <%= show_table(info, :header => "Runtime Information") do |t| %>
      <% if info.name == "???" %>
        <% t.row do %>
          This server is currently <%= html_colorize("DOWN", "red") %>.
        <% end %>
      <% else %>

        <% t.cell("Process Start Revision", :show_width => 2) { info.starttime_revision } %>
        <% t.cell("Process Start Last Change Author", :show_width => 2) { info.lc_author } %>
        <% t.cell("Process Start Last Change Revision", :show_width => 2) { info.lc_rev } %>
        <% t.cell("Process Start Last Change Date", :show_width => 2) { info.lc_date } %>
        <% t.cell("Disk Code Revision", :show_width => 2) { red_if(info.revision != info.starttime_revision, info.revision) } %>

        <% t.blank_row %>

        <% t.cell("Remote Host Name", :show_width => 2) { info.host_name == (@bourreau.proxied_host.presence || @bourreau.ssh_control_host) ? info.host_name : html_colorize(info.host_name, "red") } %>
        <% t.cell("Remote Host IP Address", :show_width => 2) { info.host_ip } %>
        <% t.cell("Remote Host OS Type", :show_width => 2) { info.host_uname } %>
        <% t.cell("Remote Host Uptime", :show_width => 2) { info.host_uptime } %>
        <% t.cell("Rails Server uptime", :show_width => 2) do %>
          Up since: <%= to_localtime(info.uptime.to_i.ago,:datetime) %>
          (for: <%= pretty_elapsed(info.uptime.to_i) %>)
        <% end %>

        <% t.blank_row %>

        <% if is_bourreau %>
          <% t.cell("Worker PIDs") { info.worker_pids } %>
          <% t.cell("Number of Tasks Running") { info.tasks_tot + " / " + info.tasks_max } %>

          <% t.cell("Workers Last Change Author") { info.worker_lc_author } %>
          <% t.cell("Cluster Management System Type") { red_if(@bourreau.cms_class != info.bourreau_cms, info.bourreau_cms) } %>

          <% t.cell("Workers Last Change Revision") { info.worker_lc_rev } %>
          <% t.cell("Cluster Management System Revision") { info.bourreau_cms_rev.svn_id_pretty_rev_author_date } %>

          <% t.cell("Workers Last Change Date") { info.worker_lc_date } %>
          <% t.empty_cell %>
        <% end %>

        <% t.blank_row %>

        <% t.cell("SSH Public Key", :show_width => 2) do %>
          <pre class="ssh_key"><%= info.ssh_public_key.strip %></pre>
        <% end %>

      <% end %>
    <% end %>
  <% end %>

</div>

<% if @bourreau.has_owner_access?(current_user) %>
  <P>
  <%= render :partial => "layouts/log_report", :locals  => { :log  => @bourreau.getlog, :title => "Server Log" } %>
<% end %>

