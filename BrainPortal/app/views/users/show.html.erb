
<% title "Account Info" %>

<% 
file_stats = ModelsReport.gather_filetype_statistics(
           :users     => @user.available_users.all,
           :providers => DataProvider.all
         )
user_fileclass_count = file_stats[:user_fileclass_count]
fileclasses_totcount = file_stats[:fileclasses_totcount]
user_totcount        = file_stats[:user_totcount]
all_totcount         = file_stats[:all_totcount]
%>

<%
stats = ModelsReport.gather_task_statistics(
           :users     => @user.available_users.all,
           :bourreaux => Bourreau.all
         )

status_stats    = stats[0]
statuses        = status_stats[:statuses]
statuses_list   = status_stats[:statuses_list]
user_tasks_info = status_stats[:user_task_info]

type_stats      = stats[1]
types           = type_stats[:types]
types_list      = type_stats[:types_list]
user_types_info = type_stats[:user_types_info]
%>

<%= javascript_tag "var current_options = null;" %>

<h2>Account details for <%= @user.full_name %></h2>

  <div class="display_cell">

   <table class = "property_list">
     <tr class="<%= cycle("list-odd", "list-even") %>">
       <th>Name:</th>
       <td><%=h @user.full_name %></td>
     </tr>
     <tr class="<%= cycle("list-odd", "list-even") %>">
       <th>Login:</th>
       <td><%=h @user.login %></td>
     </tr>
     <tr class="<%= cycle("list-odd", "list-even") %>">
       <th>Role:</th>
       <td><%=h @user.role.humanize %></td>
     </tr>
     <tr class="<%= cycle("list-odd", "list-even") %>">
       <th>Email:</th>
       <td><%= auto_link_email_addresses @user.email.html_safe %></td>
     </tr>
     <tr class="<%= cycle("list-odd", "list-even") %>">
       <th>Site:</th>
       <td><%= link_to_site_if_accessible(@user.site) %></td>
     </tr>
     <tr class="<%= cycle("list-odd", "list-even") %>">
       <th>City:</th>
       <td><%= @user.city %></td>
     </tr>
     <tr class="<%= cycle("list-odd", "list-even") %>">
        <th>Country:</th>
        <td><%= @user.country %></td>
     </tr>
     <tr class="<%= cycle("list-odd", "list-even") %>">
       <th>Time Zone:</th>
       <td><%= @user.time_zone || "(Unset)" %></td>
     </tr>
     <tr class="<%= cycle("list-odd", "list-even") %>">
       <th>Last Connected:</th>
       <td><%= @user.last_connected_at ? "#{to_localtime(@user.last_connected_at, :datetime)} (#{pretty_elapsed(Time.now - @user.last_connected_at)} ago)" : "(Never)" %></td>
     </tr>
     <tr class="<%= cycle("list-odd", "list-even") %>">
       <th>Default Execution Server:</th>
       <td><%= link_to_bourreau_if_accessible(@default_bourreau) %></td>
     </tr>
     <tr class="<%= cycle("list-odd", "list-even") %>">
       <th>Default Data Provider:</th>
       <td><%= link_to_data_provider_if_accessible(@default_data_provider) %></td>
     </tr>
     <% if current_user.has_role? :admin %>
       <tr class="<%= cycle("list-odd", "list-even") %>">
         <th>Access Report:</th>
         <td><%= link_to 'Access?', :controller => :tool_configs, :user_id => @user.id %></td>
       </tr>
     <% end %>
   </table>

  </div>

<div class="display_cell" style="padding: 1em;">
  <%= build_accordion do |acc| %>
    <%= acc.section "Edit Account Info" do %>
      <%= render :partial => "account_info" %>   
    <% end %>
    <%= acc.section "Change Password" do %>
      <%= render :partial => "change_password" %>   
    <% end %>
    <%= acc.section "Edit Preferences" do %>
      <%= render :partial => "preferences" %>   
    <% end %>
  <% end %>
</div>

  <P>

  <div>

   <table class = "resource_list">
      <tr>
        <th colspan="3">Projects</th>
      </tr>

      <tr>
        <th class="subtitle">Project Name</th>
        <th class="subtitle">Project Type</th>
        <th class="subtitle">Members</th>
      </tr>
  
   <% (@user.available_groups.sort { |g1,g2| g1.name.casecmp(g2.name) }).each do |group| %>
     <% next if group.name == 'everyone' %>
     <tr class=<%= cycle("list-even", "list-odd") %> >
       <td><%= link_to_group_if_accessible(group) %></td>
       <td><%= group.pretty_category_name(current_user) %></td>
       <td><%= array_to_table(group.users, :table_class => 'simple bordered') {|u,r,c| link_to_user_with_tooltip(u)} %></td>
     </tr>
   <% end %>

   </table>

  </div>

  <P>

  <%= render :partial => 'userfiles/file_counts',
             :locals => { :fileclasses_totcount => fileclasses_totcount,
                          :user_fileclass_count => user_fileclass_count,
                          :user_totcount        => user_totcount,
                          :all_totcount         => all_totcount,
                          :additionnal_filt     => {}
                        }
  %>
  
  <P>
  
  <%= render :partial => 'tasks/task_counts',
             :locals => { :counts           => statuses,
                          :list             => statuses_list,
                          :user_info        => user_tasks_info,
                          :additionnal_filt => {},
                          :by               => :status
             }
  %>
  
  <P>
  
  <%= render :partial => 'tasks/task_counts',
             :locals => { :counts           => types,
                          :list             => types_list,
                          :user_info        => user_types_info,
                          :additionnal_filt => {},
                          :by               => :type
                        }
  %>

  <P>

  <%= render :partial => "layouts/log_report", :locals  => { :log  => @log, :title => 'User activity report' } %>

