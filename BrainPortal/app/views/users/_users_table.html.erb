
<%-
#
# CBRAIN Project
#
# Copyright (C) 2008-2012
# The Royal Institution for the Advancement of Learning
# McGill University
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.  
#
-%>

<div class="menu_bar">
  <%= new_model_button 'Create User', new_user_path %>
  <span id="view_option_button"> 
      <%= render :partial => "view_option_button" %>
  </span>
</div>

<div class="active_status">
  <span class="active_status_left_side">
    <%= render :partial => 'shared/active_filters', :locals => {:model => :user} %>
  </span>
</div>

<div class="pagination">
  <%= render :partial => 'pagination' %>
</div>

<%= index_table(@users, :class => "resource_list") do |t| %>
  <% 
    t.sort_column("Login", "User", "login") { |u|  link_to_user_if_accessible(u, current_user, :html_options => { :class => u.account_locked ? 'error_link' : nil } ) }
    t.describe_sort_column("Full name", "User", "full_name") { |col| col.cell :class => :left, &:full_name }
    t.sort_column("Email", "User", "email") { |u|  auto_link_email_addresses h(u.email) }
    t.sort_column("Last Connection", "User", "last_connected_at") { |u|  u.last_connected_at ? to_localtime(u.last_connected_at,:datetime) : "Unknown"}
    t.column("Projects") do |u|  
      groups = u.available_groups.sort{|a, b| a.name.casecmp(b.name)}
      result = ""
      if groups.size > 0
        result += html_tool_tip(pluralize(groups.size,"project"), :offset_x => 60 ) do
                    array_to_table(groups, :table_class => 'simple', :ratio => "3:1") { |g,r,c| g.name }
                  end
      end
      result.html_safe
    end
    t.sort_column("Role", "User", "role", :filters => basic_filters_for(@header_scope, 'users', 'role')) { |u| u.role.humanize } 
    t.sort_column("Site", "Site", "name", :filters => association_filters_for(User.scoped, "user", "site")) { |u| link_to_site_if_accessible(u.site)  }
    t.sort_column("City", "User", "city", :filters => basic_filters_for(@header_scope, 'users', 'city'), &:city)
    t.sort_column("Country", "User", "country", :filters => basic_filters_for(@header_scope, 'users', 'country'), &:country)
    t.sort_column("Time Zone", "User", "time_zone") { |u| u.time_zone || "(Unset)" }
    t.column("Files") do |u|
      size = Userfile.where(:user_id => u.id).sum(:size)
      index_count_filter(@users_file_counts[u.id], :userfiles, { :user_id => u.id }, :show_zeros => 1 ) +
      ( (size > 0) ? " (#{colored_pretty_size(size)} used)" : "" ).html_safe
    end
    t.column("Tasks") do |u|
      size = CbrainTask.real_tasks.where(:user_id => u.id).sum(:cluster_workdir_size)
      unk  = CbrainTask.real_tasks.where(:user_id => u.id, :cluster_workdir_size => nil).where("cluster_workdir IS NOT NULL").count
      index_count_filter(@users_task_counts[u.id], :tasks, { :user_id => u.id }, :show_zeros => 1 ) +
      ( (size  > 0 && unk  > 0) ? " (#{colored_pretty_size(size)} used, #{unk} unkn)" :
        (size  > 0 && unk == 0) ? " (#{colored_pretty_size(size)} used)" :
        (size == 0 && unk  > 0) ? " (#{unk} unkn)" : ""
      ).html_safe
    end
    t.describe_column("Operations") do |col|
      col.cell(:if => Proc.new { |u| u != User.admin }) { |u| link_to 'Switch',  switch_user_path(u), :class => 'action_link', :method  => :post  }
      col.cell { |u| link_to 'Access?', { :controller => :tool_configs, :action => :index, :user_id => u.id }, :class => 'action_link' }
    end
  %>
<% end %> 

